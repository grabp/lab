groups:
  - name: infrastructure
    rules:
      - alert: NodeDown
        expr: up{job="nodes"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Node down: {{ $labels.instance }}"
          description: "Node exporter unreachable (role={{ $labels.role }})"

      - alert: DiskAlmostFull
        expr: |
          (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} 
           / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) < 0.10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Disk almost full on {{ $labels.instance }}"
          description: "Mount {{ $labels.mountpoint }} below 10% free"

      - alert: HighCPU
        expr: avg by (instance) (rate(node_cpu_seconds_total{mode!="idle"}[5m])) > 0.9
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"

      - alert: LowMemory
        expr: node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes < 0.10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low memory on {{ $labels.instance }}"
